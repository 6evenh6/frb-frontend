<div class="container-fluid mt-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="fw-bold text-primary mb-0 d-flex align-items-center gap-2">
        Gerenciamento de Receitas
        <span class="icon-wrapper bg-light rounded-circle d-flex align-items-center justify-content-center"
          style="width: 42px; height: 42px;">
          <i class="bi {{ iconeAtual }} text-secondary fs-4 animated-icon"></i>
        </span>
      </h2>
      <small class="text-muted">Visualize, cadastre e acompanhe seus lançamentos financeiros.</small>
    </div>
    <button class="btn btn-success" (click)="abrirFormulario()">
      <i class="bi bi-plus-circle-fill me-1"></i>
      Novo Cadastro
    </button>
  </div>

  <!-- Formulário com *ngIf -->
  <div *ngIf="exibirFormulario" class="card mb-4 animate__animated animate__fadeIn">
    <div class="card-header">Cadastro de Receitas</div>
    <div class="card-body">
      <form (ngSubmit)="salvarReceita(formReceita)" #formReceita="ngForm">
        <div class="row">

          <!-- Grupo 1: Identificação e valores -->
          <div class="col-md-6 mb-3">
            <label for="descricao" class="form-label">Descrição</label>
            <input type="text" id="descricao" name="descricao" class="form-control" [(ngModel)]="modelo.descricao"
              required />
            <div *ngIf="formReceita.controls['descricao']?.invalid && formReceita.controls['descricao']?.touched"
              class="text-danger">
              A descrição é obrigatória.
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="valorBruto" class="form-label">Valor Bruto</label>
            <input type="text" mask="separator.2" thousandSeparator="." decimalMarker="," prefix="R$ " placeholder="R$"
              class="form-control" [(ngModel)]="modelo.valorBruto" name="valorBruto" required />
            <div *ngIf="formReceita.controls['valorBruto']?.invalid && formReceita.controls['valorBruto']?.touched"
              class="text-danger">
              O valor bruto é obrigatório.
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="desconto" class="form-label">Desconto (opcional)</label>
            <input type="text" id="desconto" name="desconto" mask="separator.2" thousandSeparator="." decimalMarker=","
              prefix="R$ " placeholder="R$" class="form-control" [(ngModel)]="modelo.desconto" />
          </div>

          <div class="col-md-6 mb-3">
            <label for="acrescimos" class="form-label">Acréscimos (opcional)</label>
            <input type="text" id="acrescimos" name="acrescimos" mask="separator.2" thousandSeparator="."
              decimalMarker="," prefix="R$ " placeholder="R$" class="form-control" [(ngModel)]="modelo.acrescimos" />
          </div>

          <!-- Grupo 2: Classificação -->
          <div class="col-md-6 mb-3">
            <label class="form-label">Categoria</label>
            <select class="form-select" name="categoria" [(ngModel)]="modelo.categoria" required>
              <option [ngValue]="null" disabled selected>Selecione...</option>
              <option *ngFor="let c of categorias" [ngValue]="c.valor">{{ c.nome }}</option>
            </select>
            <div *ngIf="formReceita.controls['categoria']?.invalid && formReceita.controls['categoria']?.touched"
              class="text-danger">
              A categoria é obrigatória.
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label">Forma de Pagamento</label>
            <select class="form-select" name="formaPagamento" [(ngModel)]="modelo.formaPagamento" required>
              <option [ngValue]="null" disabled selected>Selecione...</option>
              <option *ngFor="let f of formasPagamento" [ngValue]="f.valor">{{ f.nome }}</option>
            </select>
            <div
              *ngIf="formReceita.controls['formaPagamento']?.invalid && formReceita.controls['formaPagamento']?.touched"
              class="text-danger">
              A forma de pagamento é obrigatória.
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="statusPagamento" class="form-label">Status do Pagamento</label>
            <select id="statusPagamento" class="form-select" [(ngModel)]="modelo.statusPagamento" name="statusPagamento"
              required>
              <option [ngValue]="null" disabled selected>Selecione...</option>
              <option *ngFor="let status of statusPagamentoOptions" [ngValue]="status.valor">{{ status.nome }}</option>
            </select>
          </div>

          <!-- Grupo 3: Datas -->
          <div class="col-md-6 mb-3">
            <label for="dataVencimento" class="form-label">Data de Vencimento</label>
            <input type="date" id="dataVencimento" name="dataVencimento" class="form-control"
              [(ngModel)]="modelo.dataVencimento" />
          </div>

          <div class="col-md-6 mb-3">
            <label for="dataPagamento" class="form-label d-flex align-items-center">
              Data de Pagamento
              <i class="bi bi-info-circle ms-2 text-muted" tabindex="0" data-bs-toggle="tooltip" data-bs-placement="top"
                title="Data em que o valor foi efetivamente recebido (ex: quando o cheque é compensado ou o dinheiro entra na conta)."
                style="cursor: pointer;"></i>
            </label>
            <input type="date" id="dataPagamento" name="dataPagamento" class="form-control"
              [(ngModel)]="modelo.dataPagamento" />
          </div>

          <!-- Grupo 4: Dados bancários -->

          <div class="col-md-6 mb-3">
            <label for="conta" class="form-label">Pix</label>
            <input type="text" class="form-control" name="conta" [(ngModel)]="modelo.pix"
              placeholder="Informe a chave Pix (CPF, telefone, e-mail ou chave aleatória)" />
          </div>

          <div *ngIf="modelo.formaPagamento === 3" class="col-12 mb-3">
            <label class="form-label">Cheques</label>

            <div *ngFor="let cheque of modelo.cheques; let i = index" class="border p-3 mb-3 rounded bg-light-subtle">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Número</label>
                  <input type="text" class="form-control" [(ngModel)]="cheque.numeroCheque" name="numeroCheque{{i}}"
                    required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Valor</label>
                  <input type="text" class="form-control" mask="separator.2" thousandSeparator="." decimalMarker=","
                    prefix="R$ " [(ngModel)]="cheque.valor" name="valorCheque{{i}}" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Data Compensação</label>
                  <input type="date" class="form-control" [(ngModel)]="cheque.dataCompensacao"
                    name="dataCompensacao{{i}}" required />
                </div>
                <div class="col-md-2">
                  <label class="form-label d-block">Compensado</label>
                  <input type="checkbox" class="form-check-input me-2" [(ngModel)]="cheque.compensado"
                    name="compensado{{i}}" />
                  <span>{{ cheque.compensado ? 'Sim' : 'Não' }}</span>
                </div>
                <div class="col-md-1 text-end">
                  <button type="button" class="btn btn-outline-danger btn-sm" (click)="removerCheque(i)">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>

            <button type="button" class="btn btn-outline-primary btn-sm" (click)="adicionarCheque()"
              [disabled]="isChequeInvalido()">
              <i class="bi bi-plus-lg"></i> Adicionar Cheque
            </button>
          </div>

          <!-- Grupo 5: Observações -->
          <div class="col-12 mb-3">
            <label for="observacoesInternas" class="form-label">Observações Internas</label>
            <textarea id="observacoesInternas" name="observacoesInternas" class="form-control" rows="3"
              [(ngModel)]="modelo.observacoesInternas"></textarea>
          </div>

        </div>


        <div class="text-end mt-3">
          <button type="submit" class="btn btn-primary" [disabled]="formReceita.invalid">
            Adicionar Receita
          </button>
          <button type="button" class="btn btn-secondary ms-2" (click)="cancelar()">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <h4 class="mb-3">Suas Receitas Cadastradas</h4>

  <div *ngIf="receitas.length === 0" class="alert alert-info text-center">
    Nenhuma receita cadastrada ainda. Use o formulário acima para adicionar!
  </div>

  <div class="table-responsive" *ngIf="receitas.length > 0">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Descrição</th>
          <th scope="col">Valor Líquido</th>
          <th scope="col">Forma Pagamento</th>
          <th scope="col">Status</th>
          <th scope="col">Data de Pagamento</th>
          <th scope="col" class="text-center">Ações</th>
        </tr>
      </thead>
      <tbody>
        @for (receita of displayedReceitas; track receita.id) {
        <tr>
          <th scope="row">{{ receita.id }}</th>
          <td>{{ receita.descricao || '-' }}</td>
          <td>R$ {{ receita.valorLiquido | number : '1.2-2' }}</td>
          <td>{{ getNomeFormaPagamento(receita.formaPagamento) }}</td>
          <td>{{ getNomeStatusPagamento(receita.statusPagamento) }}</td>
          <td>{{ receita.dataPagamento | date : 'dd/MM/yyyy' }}</td>
          <td class="text-center">
            <!-- Visualizar Detalhes -->
            <button class="btn btn-sm btn-outline-secondary me-1" title="Visualizar"
              (click)="abrirModalDetalhes(receita)">
              <i class="bi bi-eye-fill"></i>
            </button>

            <!-- Editar -->
            <button class="btn btn-sm btn-outline-primary me-1" title="Editar" (click)="editarReceita(receita)">
              <i class="bi bi-pencil-fill"></i>
            </button>

            <!-- Excluir -->
            <button class="btn btn-sm btn-outline-danger" title="Excluir" (click)="excluirReceita(receita.id)">
              <i class="bi bi-trash-fill"></i>
            </button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>


  <!-- Paginação da Table -->
  <div *ngIf="receitas.length > 0" class="d-flex justify-content-between p-2">
    <ngb-pagination [collectionSize]="collectionSize" [(page)]="page" [pageSize]="pageSize"
      (pageChange)="refreshReceitas()">
    </ngb-pagination>

    <select class="form-select" style="width: auto" [(ngModel)]="pageSize" (ngModelChange)="refreshReceitas()">
      <option [ngValue]="2">2 itens por página</option>
      <option [ngValue]="4">4 itens por página</option>
      <option [ngValue]="6">6 itens por página</option>
      <option [ngValue]="10">10 itens por página</option>
    </select>
  </div>

  <!-- Modal de Detalhes -->
  <ng-template #modalDetalhes let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Detalhes da Receita #{{ receitaSelecionada?.id }}</h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
    </div>

    <div class="modal-body">
      <dl class="row">
        <dt class="col-sm-4">Descrição</dt>
        <dd class="col-sm-8">{{ receitaSelecionada?.descricao || '-' }}</dd>

        <dt class="col-sm-4">Valor Bruto</dt>
        <dd class="col-sm-8">R$ {{ receitaSelecionada?.valorBruto | number: '1.2-2' }}</dd>

        <dt class="col-sm-4">Desconto</dt>
        <dd class="col-sm-8">{{ receitaSelecionada?.desconto ? ('R$ ' + (receitaSelecionada?.desconto | number:
          '1.2-2')) : '-' }}</dd>

        <dt class="col-sm-4">Acréscimos</dt>
        <dd class="col-sm-8">{{ receitaSelecionada?.acrescimos ? ('R$ ' + (receitaSelecionada?.acrescimos | number:
          '1.2-2')) : '-' }}</dd>

        <dt class="col-sm-4">Valor Líquido</dt>
        <dd class="col-sm-8">R$ {{ receitaSelecionada?.valorLiquido | number: '1.2-2' }}</dd>

        <dt class="col-sm-4">Categoria</dt>
        <dd class="col-sm-8">{{ getNomeCategoria(receitaSelecionada?.categoria!) }}</dd>

        <dt class="col-sm-4">Forma de Pagamento</dt>
        <dd class="col-sm-8">{{ getNomeFormaPagamento(receitaSelecionada?.formaPagamento!) }}</dd>

        <dt class="col-sm-4">Status Pagamento</dt>
        <dd class="col-sm-8">{{ getNomeStatusPagamento(receitaSelecionada?.statusPagamento!) }}</dd>

        <dt class="col-sm-4">Data Receita</dt>
        <dd class="col-sm-8">{{ receitaSelecionada?.dataReceita | date: 'dd/MM/yyyy' }}</dd>

        <dt class="col-sm-4">Data Vencimento</dt>
        <dd class="col-sm-8">{{ receitaSelecionada?.dataVencimento ? (receitaSelecionada?.dataVencimento | date:
          'dd/MM/yyyy') : '-' }}</dd>

        <dt class="col-sm-4">Data Pagamento</dt>
        <dd class="col-sm-8">{{ receitaSelecionada?.dataPagamento ? (receitaSelecionada?.dataPagamento | date:
          'dd/MM/yyyy') : '-' }}</dd>

        <dt class="col-sm-4">Conta</dt>
        <dd class="col-sm-8">{{ receitaSelecionada?.pix || '-' }}</dd>

        <dt class="col-sm-4">Cheques</dt>
        <dd class="col-sm-8">
          <div *ngIf="(receitaSelecionada?.cheques ?? []).length > 0; else semCheques">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Número</th>
                  <th>Valor</th>
                  <th>Data Compensação</th>
                  <th>Compensado?</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let cheque of receitaSelecionada?.cheques">
                  <td>{{ cheque.numeroCheque }}</td>
                  <td>R$ {{ cheque.valor | number: '1.2-2' }}</td>
                  <td>{{ cheque.dataCompensacao | date: 'dd/MM/yyyy' }}</td>
                  <td>
                    <span class="badge" [ngClass]="cheque.compensado ? 'bg-success' : 'bg-warning text-dark'">
                      {{ cheque.compensado ? 'Sim' : 'Não' }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #semCheques>
            <span class="text-muted">Nenhum cheque informado.</span>
          </ng-template>
        </dd>

        <dt class="col-sm-4">Observações Internas</dt>
        <dd class="col-sm-8">{{ receitaSelecionada?.observacoesInternas || '-' }}</dd>
      </dl>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="modal.close()">Fechar</button>
    </div>
  </ng-template>


</div>